name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGION: us-central1
  FRONTEND_SERVICE: pg-manager-pro-frontend
  BACKEND_SERVICE: pg-manager-pro-backend
  ARTIFACT_REGISTRY: us-central1-docker.pkg.dev

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: github-actions-sa@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com
          token_format: access_token

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }} --quiet

      - name: Build and Push Frontend Image
        run: |
          docker build -t ${{ env.ARTIFACT_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/pg-manager-pro/${{ env.FRONTEND_SERVICE }}:${{ github.sha }} .
          docker build -t ${{ env.ARTIFACT_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/pg-manager-pro/${{ env.FRONTEND_SERVICE }}:latest .
          docker push ${{ env.ARTIFACT_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/pg-manager-pro/${{ env.FRONTEND_SERVICE }}:${{ github.sha }}
          docker push ${{ env.ARTIFACT_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/pg-manager-pro/${{ env.FRONTEND_SERVICE }}:latest

      - name: Build and Push Backend Image
        run: |
          docker build -f Dockerfile.server -t ${{ env.ARTIFACT_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/pg-manager-pro/${{ env.BACKEND_SERVICE }}:${{ github.sha }} .
          docker build -f Dockerfile.server -t ${{ env.ARTIFACT_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/pg-manager-pro/${{ env.BACKEND_SERVICE }}:latest .
          docker push ${{ env.ARTIFACT_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/pg-manager-pro/${{ env.BACKEND_SERVICE }}:${{ github.sha }}
          docker push ${{ env.ARTIFACT_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/pg-manager-pro/${{ env.BACKEND_SERVICE }}:latest

      - name: Deploy Backend to Cloud Run
        id: deploy-backend
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.BACKEND_SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ env.ARTIFACT_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/pg-manager-pro/${{ env.BACKEND_SERVICE }}:${{ github.sha }}
          flags: |
            --allow-unauthenticated
            --port=3001
            --memory=512Mi
            --cpu=1
            --min-instances=0
            --max-instances=10

      - name: Deploy Frontend to Cloud Run
        id: deploy-frontend
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.FRONTEND_SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ env.ARTIFACT_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/pg-manager-pro/${{ env.FRONTEND_SERVICE }}:${{ github.sha }}
          flags: |
            --allow-unauthenticated
            --port=8080
            --memory=256Mi
            --cpu=1
            --min-instances=0
            --max-instances=10
          env_vars: |
            VITE_API_URL=${{ steps.deploy-backend.outputs.url }}

      - name: Show Deployment URLs
        run: |
          echo "ðŸš€ Deployment Complete!"
          echo "ðŸ“± Frontend URL: ${{ steps.deploy-frontend.outputs.url }}"
          echo "ðŸ”§ Backend URL: ${{ steps.deploy-backend.outputs.url }}"
